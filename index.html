<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hikes!</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
    <![endif]-->
    <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <style type="text/css">
        #map {
            width: 100%;
            min-height: 400px;
        }

        #sidebar {
            padding: 10px;
            overflow-y: scroll;
        }
    </style>
    <link rel="stylesheet" href="static/vendor/bootstrap/css/bootstrap.min.css">
</head>
<body>
    <div class="row-fluid">
        <div class="span2" id="sidebar">
            <h1>Hikes I've been on</h1>
            <p class="lead">
                This an interactive map of the GPS tracks I've taken while hiking various trails in the PNW.
            </p>
            <div class="hikes-2013 hike-list">
                <h2>2013</h2>
                <ul>
                    <li><a href="hikes-2013/20130615-oyster-dome-trail/hike-oyster-dome-trail-20130615-all.geojson">Oyster Dome Trail</a></li>
                    <li><a href="hikes-2013/20130526-bayocean-spit/20130526-bayocean-spit-all.geojson">Bayocean Spit</a></li>
                </ul>
            </div>
            <div class="hikes-2012 hike-list">
                <h2>2012</h2>
            </div>
        </div>
        <div class="span10">
            <div id="map"></div>
        </div>
    </div>
    <script>
        (function () {

            function parseGeoJson(data) {
                return L.geoJson(JSON.parse(data),
                    {
                        onEachFeature: function (feature, layer) {
                            var prop,
                                popup = '<table>';
                            if (feature.properties) {
                                for (prop in feature.properties) {
                                    popup += '<tr><td>' + prop + '</td><td>' + feature.properties[prop] + '</td></tr>\n';
                                }

                                popup += '</table>';

                                layer.bindPopup(popup);
                            }
                        }
                    }
                );
            }

            /**
             * Retreives geojson track data, places it in the map and returns the Leaflet
             * geoJSON object for further manipulation
             * @param  {String} url             url for geojson
             * @param  {Function} callbackSuccess callback for successful retreival of geojson
             * @param  {Function} callbackError   callback for error
             * @return {Object} L.geoJson object.
             */
            function getTrack(url, callbackSuccess, callbackError) {
                // retreive the geojson data
                function success(data) {
                    var track = parseGeoJson(data);
                    track.addTo(map);

                    if (typeof callbackSuccess === 'function') {
                        callbackSuccess(track);
                    }
                }

                function error(jqXHR) {
                    console.log('wrong');
                    if (typeof callbackError === 'function') {
                        callbackError(track);
                    }
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: success,
                    error: error
                })
            }

            function focusTrack(track) {
                map.fitBounds(track.getBounds());
            }

            function resizeMap() {
                // init the map size
                $('#map, #sidebar').css({
                    height: $(window).outerHeight()
                });
                map.invalidateSize(true);

            }
            // init map
            var map = L.map('map').setView([51.505, -0.09], 13);
            L.tileLayer('http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenCycleMap, ' + 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
            }).addTo(map);

            $(document).ready(function () {

                // bind events
                $('.hike-list')
                    .on('click', 'a', function (e) {
                        e.preventDefault();

                        var $a = $(e.target);

                        if ($a.data('cachedTrack')) {
                            map.fitBounds($a.data('cachedTrack').getBounds());
                        } else {

                            function success(track) {
                                focusTrack(track);
                                $a.data('cachedTrack', track);
                            }

                            getTrack($a.attr('href'), success);
                        }

                    });

                $(window).resize(function () {
                    resizeMap();
                });

                resizeMap();
                getTrack($('.hike-list a').eq(0).attr('href'), focusTrack);

            });
        }(this));

    </script>
</body>
</html>